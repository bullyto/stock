<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Stock Véhicule</title>

  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#05070b" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg0:#020308; --bg1:#05070b; --bg2:#070a10;
      --txt:#ecf3ff; --mut:#9fb0c8;
      --accent:#39d98a; --accent2:#47c9ff; --warn:#ffb020; --bad:#ff4d6d;
      --shadow: 0 26px 80px rgba(0,0,0,.72);
      --shadow2: 0 14px 40px rgba(0,0,0,.58);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--txt);
      background:
        radial-gradient(1100px 780px at 16% 10%, rgba(71,201,255,.10), transparent 60%),
        radial-gradient(980px 760px at 84% 14%, rgba(57,217,138,.09), transparent 60%),
        radial-gradient(1300px 950px at 50% 120%, rgba(57,217,138,.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 42%, var(--bg2));
      overflow-x:hidden;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:10px 14px 0}
    .header{
      position: sticky; top: 0; z-index: 60;
      padding-top: env(safe-area-inset-top);
      background: linear-gradient(180deg, rgba(2,3,8,.97), rgba(2,3,8,.84) 65%, rgba(2,3,8,0));
      backdrop-filter: blur(12px);
    }
    .headerInner{display:flex; gap:12px; align-items:flex-start; justify-content:space-between; padding: 10px 0 12px;}
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(71,201,255,.28), transparent 55%),
        radial-gradient(18px 18px at 70% 70%, rgba(57,217,138,.26), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
      position:relative; overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 0deg, rgba(71,201,255,0), rgba(71,201,255,.35), rgba(57,217,138,.35), rgba(71,201,255,0));
      animation: spin 7s linear infinite;
      filter: blur(12px);
      opacity:.65;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .titleBox{line-height:1.12}
    .title{font-size:16px;font-weight:950;letter-spacing:.3px}
    .subtitle{margin-top:4px;font-size:12px;color:var(--mut);letter-spacing:.2px}
    .subtitle strong{color:rgba(236,243,255,.88); font-weight:900}

    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 9px 10px; border-radius: 999px;
      background: rgba(255,255,255,.045);
      border:1px solid rgba(255,255,255,.08);
      color: var(--mut); font-size:12px; white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%; background: var(--accent); box-shadow: 0 0 0 6px rgba(57,217,138,.09);}
    .dot.off{background: rgba(255,255,255,.38); box-shadow: 0 0 0 6px rgba(255,255,255,.06);}
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color:var(--txt);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      font-size: 13px;
      display:inline-flex; align-items:center; gap:10px;
      cursor:pointer; box-shadow: 0 10px 26px rgba(0,0,0,.40);
      user-select:none; transition: transform .08s ease, filter .15s ease, opacity .15s ease;
    }
    .btn:hover{filter:brightness(1.07)}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.55; cursor:not-allowed; filter:none}
    .btn.primary{
      border-color: rgba(57,217,138,.22);
      background: linear-gradient(180deg, rgba(57,217,138,.16), rgba(255,255,255,.05));
    }
    .icon{width:18px;height:18px;display:inline-block}

    .toolbar{margin-top: 10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .search{
      flex: 1 1 220px;
      display:flex; align-items:center; gap:10px;
      padding: 12px 12px; border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.045);
      box-shadow: var(--shadow2);
    }
    .search input{
      flex:1; background: transparent; border:0; outline:none;
      color: var(--txt); font-size: 14px; font-weight: 850;
    }
    .search input::placeholder{color: rgba(159,176,200,.65); font-weight:800}

    .seg{
      display:flex; gap:8px; align-items:center;
      padding: 6px; border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.045);
      box-shadow: var(--shadow2);
    }
    .seg button{
      border:0; background: transparent; color: var(--mut);
      padding: 10px 12px; border-radius: 12px;
      font-weight: 950; font-size: 13px; cursor:pointer;
    }
    .seg button.active{
      background: rgba(255,255,255,.08);
      color: var(--txt);
      border: 1px solid rgba(255,255,255,.10);
    }

    .grid{margin-top: 14px; display:grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding-bottom: 96px;}
    @media (max-width: 1050px){ .grid{grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 820px){ .grid{grid-template-columns: repeat(2, 1fr);} }

    .card{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.055), rgba(255,255,255,.03));
      box-shadow: var(--shadow2);
      overflow:hidden; position:relative; cursor:pointer;
      transition: transform .12s ease, filter .2s ease;
      user-select:none;
    }
    .card:hover{filter:brightness(1.06)}
    .card:active{transform:translateY(1px)}
    .cardTop{
      padding: 14px 14px 10px;
      min-height: 140px;
      display:flex; align-items:center; justify-content:center;
      background:
        radial-gradient(220px 140px at 50% 50%, rgba(71,201,255,.085), transparent 60%),
        radial-gradient(220px 140px at 70% 30%, rgba(57,217,138,.08), transparent 60%);
      position:relative;
    }

    .bottle{
      width: 104px;
      height: 128px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
      box-shadow: 0 18px 55px rgba(0,0,0,.50);
      display:flex; align-items:center; justify-content:center;
      position:relative; overflow:hidden;
    }
    .bottle img{width:100%;height:100%;object-fit:contain;display:block}
    .bottle .fallback{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-weight: 1100; letter-spacing: .6px;
      color: rgba(236,243,255,.70);
      font-size: 12px;
    }
    .bottle.hasimg .fallback{display:none}

    .badgeQty{
      position:absolute; top: 10px; right: 10px;
      padding: 8px 10px; border-radius: 999px;
      font-weight: 1000; font-size: 12px;
      color: #06110c;
      background: linear-gradient(180deg, rgba(57,217,138,.95), rgba(57,217,138,.65));
      box-shadow: 0 16px 45px rgba(57,217,138,.18);
      border: 1px solid rgba(255,255,255,.18);
      min-width: 44px; text-align:center;
    }
    .badgeLow{background: linear-gradient(180deg, rgba(255,176,32,.95), rgba(255,176,32,.65)); box-shadow: 0 16px 45px rgba(255,176,32,.18);}
    .badgeZero{background: linear-gradient(180deg, rgba(255,77,109,.95), rgba(255,77,109,.60)); box-shadow: 0 16px 45px rgba(255,77,109,.18); color:#12030a;}

    .cardBody{padding: 12px 14px 14px}
    .name{font-weight: 1000; font-size: 13px; line-height: 1.2; letter-spacing: .2px; margin: 0 0 8px;}
    .metaRow{display:flex; align-items:center; justify-content:space-between; gap:10px; color: var(--mut); font-size: 12px; font-weight: 850;}
    .tag{padding: 7px 9px; border-radius: 999px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.045); color: rgba(159,176,200,.9); font-size: 11px; font-weight: 950; white-space:nowrap;}

    .sheetBackdrop{position:fixed; inset:0; background: rgba(0,0,0,.68); backdrop-filter: blur(10px); opacity:0; pointer-events:none; transition: opacity .18s ease; z-index: 90;}
    .sheetBackdrop.show{opacity:1; pointer-events:auto;}
    .sheet{position:fixed; left:0; right:0; bottom: -430px; transition: transform .22s ease; z-index: 95; padding: 0 12px calc(env(safe-area-inset-bottom) + 12px);}
    .sheet.show{transform: translateY(-430px);}
    .sheetInner{max-width: 720px; margin: 0 auto; border-radius: 26px; border:1px solid rgba(255,255,255,.12); background: linear-gradient(180deg, rgba(9,12,18,.94), rgba(6,8,12,.94)); box-shadow: var(--shadow); overflow:hidden;}
    .sheetHandle{width: 60px; height: 5px; border-radius:999px; background: rgba(255,255,255,.18); margin: 10px auto 8px;}
    .sheetContent{padding: 10px 14px 14px}
    .sheetTitleRow{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; padding: 4px 2px 10px;}
    .sheetTitle{font-weight:1000;font-size:16px;letter-spacing:.2px;margin:0}
    .sheetSub{margin-top:6px;color:var(--mut);font-size:12px;font-weight:850}
    .qtyBig{font-size: 28px; font-weight: 1100; letter-spacing:.5px; padding: 10px 14px; border-radius: 18px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05); min-width: 88px; text-align:center;}
    .controls{display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;}
    .ctl{padding: 14px 14px; border-radius: 18px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05); display:flex; align-items:center; justify-content:center; gap:10px; font-weight: 1000; cursor:pointer; user-select:none;}
    .ctl.plus{border-color: rgba(57,217,138,.22); background: linear-gradient(180deg, rgba(57,217,138,.18), rgba(255,255,255,.05));}
    .ctl.minus{border-color: rgba(255,77,109,.18); background: linear-gradient(180deg, rgba(255,77,109,.14), rgba(255,255,255,.05));}
    .ctl:active{transform:translateY(1px)}
    .rowChips{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}

    .fab{position: fixed; right: 16px; bottom: calc(env(safe-area-inset-bottom) + 16px); z-index: 80;
      width: 62px; height: 62px; border-radius: 22px;
      border: 1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(30px 30px at 30% 30%, rgba(71,201,255,.36), transparent 60%),
        radial-gradient(30px 30px at 70% 70%, rgba(57,217,138,.36), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      box-shadow: 0 22px 70px rgba(0,0,0,.62);
      display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; overflow:hidden;
      opacity: .96;
    }
    .fab:after{content:""; position:absolute; inset:-60%;
      background: conic-gradient(from 0deg, rgba(71,201,255,0), rgba(71,201,255,.44), rgba(57,217,138,.44), rgba(71,201,255,0));
      filter: blur(14px); opacity:.52; animation: spin 7s linear infinite;
    }
    .fab svg{position:relative}

    .modal{position:fixed; inset:0; background: rgba(0,0,0,.72); backdrop-filter: blur(10px); z-index: 110;
      opacity:0; pointer-events:none; transition: opacity .18s ease;
      display:flex; align-items:flex-end; padding: 12px; padding-bottom: calc(env(safe-area-inset-bottom) + 12px);
    }
    .modal.show{opacity:1; pointer-events:auto;}
    .modalCard{width:100%; max-width: 720px; margin: 0 auto; border-radius: 26px; border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(9,12,18,.95), rgba(6,8,12,.95)); box-shadow: var(--shadow); overflow:hidden;
    }
    .modalTop{padding: 12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px; border-bottom: 1px solid rgba(255,255,255,.10);}
    .modalTop b{font-weight:1000; letter-spacing:.2px}
    .modalTop .right{display:flex; gap:10px; align-items:center}
    .miniBtn{border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05); color: var(--txt);
      padding: 10px 12px; border-radius: 14px; font-weight: 950; font-size: 13px; cursor:pointer; user-select:none;
    }
    .miniBtn:active{transform:translateY(1px)}
    .miniBtn.primary{border-color: rgba(71,201,255,.22); background: linear-gradient(180deg, rgba(71,201,255,.16), rgba(255,255,255,.05));}
    .videoBox{position:relative; background: #000; aspect-ratio: 16 / 9; width: 100%; overflow:hidden;}
    video{width:100%; height:100%; object-fit:cover; display:block}
    .scanOverlay{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;}
    .scanFrame{width: 70%; max-width: 420px; aspect-ratio: 1.9 / 1; border-radius: 20px; border: 2px solid rgba(71,201,255,.55);
      box-shadow: 0 0 0 10px rgba(71,201,255,.10), 0 0 40px rgba(71,201,255,.20); position:relative;
    }
    .scanFrame:after{content:""; position:absolute; left:10px; right:10px; top:50%; height:2px;
      background: rgba(57,217,138,.75); box-shadow: 0 0 18px rgba(57,217,138,.35);
      transform: translateY(-50%); opacity:.9;
    }
    .modalBody{padding: 12px 14px}
    .scanResult{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      padding: 12px; border-radius: 18px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04);
    }
    .scanResult .left{display:flex; flex-direction:column; gap:6px}
    .scanResult .small{color:var(--mut); font-size:12px; font-weight:850}
    .scanResult .big{font-weight:1000}
    .confirmRow{margin-top: 10px; display:grid; grid-template-columns: 1fr 1fr; gap: 10px;}
    .confirmRow button{width:100%; padding: 14px 14px; border-radius: 18px; border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05); color:var(--txt); font-weight:1000; cursor:pointer; user-select:none;
    }
    .confirmRow button.ok{border-color: rgba(57,217,138,.22); background: linear-gradient(180deg, rgba(57,217,138,.18), rgba(255,255,255,.05));}
    .confirmRow button.no{border-color: rgba(255,77,109,.18); background: linear-gradient(180deg, rgba(255,77,109,.14), rgba(255,255,255,.05));}
    .confirmRow button:active{transform:translateY(1px)}
    .confirmRow button:disabled{opacity:.55; cursor:not-allowed}

    /* Settings (token only) */
    .settings{position:fixed; inset:0; z-index: 130;
      background: rgba(0,0,0,.72); backdrop-filter: blur(12px);
      opacity:0; pointer-events:none; transition: opacity .18s ease;
      display:flex; align-items:flex-end; padding: 12px; padding-bottom: calc(env(safe-area-inset-bottom) + 12px);
    }
    .settings.show{opacity:1; pointer-events:auto;}
    .settingsCard{width:100%; max-width: 720px; margin: 0 auto; border-radius: 26px; border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(9,12,18,.96), rgba(6,8,12,.96)); box-shadow: var(--shadow); overflow:hidden;
    }
    .settingsTop{padding: 12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px; border-bottom: 1px solid rgba(255,255,255,.10);}
    .settingsTop b{font-weight:1000; letter-spacing:.2px}
    .settingsBody{padding: 12px 14px}
    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-size:12px; color: rgba(159,176,200,.86); font-weight:900}
    .field input{
      padding: 12px 12px; border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--txt);
      outline:none;
      font-weight: 900;
    }
    .help{margin-top:10px; color: rgba(159,176,200,.82); font-size:12px; font-weight:850; line-height:1.35}
    .help code{background: rgba(255,255,255,.06); padding: 2px 6px; border-radius: 8px; border:1px solid rgba(255,255,255,.10)}
    .settingsActions{margin-top:12px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .settingsActions .btn{width:100%; justify-content:center}
    .settingsActions .btn.primary{justify-content:center}

    .toast{position: fixed; left: 50%; bottom: calc(env(safe-area-inset-bottom) + 92px);
      transform: translateX(-50%);
      padding: 10px 12px; border-radius: 999px; border:1px solid rgba(255,255,255,.12);
      background: rgba(6,8,12,.84); box-shadow: var(--shadow2);
      color: var(--mut); font-size: 12px; font-weight: 900;
      opacity: 0; pointer-events:none; transition: opacity .18s ease, transform .18s ease;
      z-index: 140; backdrop-filter: blur(10px); white-space:nowrap;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-4px);}
  </style>
</head>

<body>
  <div class="header">
    <div class="wrap">
      <div class="headerInner">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="titleBox">
            <div class="title">Stock Véhicule</div>
            <div class="subtitle" id="subtitleLine">
              Temps réel • Tap sur une bouteille pour ajuster (+/–)
              <br><strong id="miniStats">—</strong>
            </div>
          </div>
        </div>

        <div class="actions">
          <div class="chip"><span class="dot off" id="dotNet"></span><span id="chipStatus">Offline</span></div>

          <button class="btn" type="button" id="btnSettings" title="Token GitHub">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="2"/>
              <path d="M19.4 15a7.8 7.8 0 0 0 .1-1l2-1.2-2-3.5-2.3.7a7.8 7.8 0 0 0-1.7-1L15 4h-6l-.5 2.9a7.8 7.8 0 0 0-1.7 1L4.5 7.2l-2 3.5 2 1.2a7.8 7.8 0 0 0 0 2l-2 1.2 2 3.5 2.3-.7a7.8 7.8 0 0 0 1.7 1L9 20h6l.5-2.9a7.8 7.8 0 0 0 1.7-1l2.3.7 2-3.5-2-1.2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
            Token
          </button>

          <button class="btn primary" type="button" id="btnSaveRepo" title="Enregistrer le stock en dépôt (GitHub)">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M8 9l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M5 14v5h14v-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Enregistrer dépôt
          </button>
        </div>
      </div>

      <div class="toolbar">
        <div class="search">
          <svg class="icon" viewBox="0 0 24 24" fill="none">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"/>
            <path d="M16.3 16.3 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <input id="q" type="text" placeholder="Rechercher une bouteille…" />
        </div>

        <div class="seg" role="tablist" aria-label="Filtres">
          <button id="fAll" class="active" type="button">Tout</button>
          <button id="fLow" type="button">Faible</button>
          <button id="fZero" type="button">Rupture</button>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid" id="grid"></div>
  </div>

  <div class="fab" id="fabScan" title="Scanner EAN">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
      <path d="M7 7h3M7 7V4h3M17 7h-3M17 7V4h-3M7 17h3M7 17v3h3M17 17h-3M17 17v3h-3" stroke="white" stroke-width="2" stroke-linecap="round"/>
      <path d="M8 12h8" stroke="white" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </div>

  <div class="sheetBackdrop" id="backdrop"></div>
  <div class="sheet" id="sheet">
    <div class="sheetInner">
      <div class="sheetHandle"></div>
      <div class="sheetContent">
        <div class="sheetTitleRow">
          <div>
            <h3 class="sheetTitle" id="sheetName">—</h3>
            <div class="sheetSub">Ajuster le stock</div>
          </div>
          <div class="qtyBig" id="sheetQty">0</div>
        </div>

        <div class="controls">
          <div class="ctl minus" id="btnMinus">— 1</div>
          <div class="ctl plus" id="btnPlus">+ 1</div>
        </div>

        <div class="rowChips">
          <div class="chip"><span class="dot" style="background:var(--accent2)"></span><span>Tap carte = ouvrir</span></div>
          <div class="chip"><span class="dot" style="background:var(--warn)"></span><span>Faible ≤ 2</span></div>
          <div class="chip"><span class="dot" style="background:var(--bad)"></span><span>Rupture = 0</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="scanModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalTop">
        <b>Scanner une bouteille</b>
        <div class="right">
          <button class="miniBtn" id="btnTorch" type="button">Flash</button>
          <button class="miniBtn primary" id="btnCloseScan" type="button">Fermer</button>
        </div>
      </div>

      <div class="videoBox">
        <video id="video" playsinline></video>
        <div class="scanOverlay"><div class="scanFrame"></div></div>
      </div>

      <div class="modalBody">
        <div class="scanResult">
          <div class="left">
            <div class="small">EAN détecté</div>
            <div class="big" id="eanText">—</div>
            <div class="small" id="matchText">Présente la bouteille dans le cadre</div>
          </div>
          <div class="badgeQty" id="scanBadge">x0</div>
        </div>

        <div class="confirmRow">
          <button class="no" id="btnCancelDeduct" type="button">Annuler</button>
          <button class="ok" id="btnConfirmDeduct" type="button">Confirmer : -1</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings (Token only) -->
  <div class="settings" id="settings" aria-hidden="true">
    <div class="settingsCard">
      <div class="settingsTop">
        <b>Token GitHub (PAT)</b>
        <div class="right">
          <button class="miniBtn primary" id="btnCloseSettings" type="button">Fermer</button>
        </div>
      </div>

      <div class="settingsBody">
        <div class="field">
          <label>Token GitHub (PAT)</label>
          <input id="ghToken" placeholder="ghp_… / github_pat_…" autocomplete="off" />
        </div>

        <div class="help">
          • Dépôt utilisé par défaut : <code>bullyto/stock</code> (branch <code>main</code>)<br>
          • Stock = <strong>1 fichier par bouteille</strong> : <code>stock/&lt;id-bouteille&gt;.json</code> + un <code>stock/_snapshot.json</code><br>
          • Le token est stocké <strong>uniquement en local</strong> (LocalStorage).<br>
          • Sans token : tu peux lire (repo public). Avec token : tu peux <strong>écrire</strong> (enregistrer dépôt).
        </div>

        <div class="settingsActions">
          <button class="btn" id="btnPullRepo" type="button">Charger depuis dépôt</button>
          <button class="btn primary" id="btnSaveToken" type="button">Enregistrer token</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">—</div>

<script>
"use strict";

/* ========= PWA / Service Worker (update sans galère) ========= */
const chipStatus = document.getElementById("chipStatus");
const dotNet = document.getElementById("dotNet");

async function registerSW(){
  if (!("serviceWorker" in navigator)) return;
  try{
    const reg = await navigator.serviceWorker.register("./sw.js");
    reg.update?.();

    if (reg.waiting) reg.waiting.postMessage({ type:"SKIP_WAITING" });

    navigator.serviceWorker.addEventListener("controllerchange", () => {
      if (window.__reloadedOnce) return;
      window.__reloadedOnce = true;
      location.reload();
    });

    reg.addEventListener("updatefound", () => {
      const nw = reg.installing;
      if(!nw) return;
      nw.addEventListener("statechange", () => {
        if (nw.state === "installed" && navigator.serviceWorker.controller) {
          reg.waiting?.postMessage({ type:"SKIP_WAITING" });
        }
      });
    });
  }catch{}
}

function updateOnlineUI(){
  const online = navigator.onLine;
  chipStatus.textContent = online ? "Online" : "Offline";
  dotNet.classList.toggle("off", !online);
}
window.addEventListener("online", updateOnlineUI);
window.addEventListener("offline", updateOnlineUI);
window.addEventListener("load", () => { updateOnlineUI(); registerSW(); });

/* ========= Data ========= */
const LOW_THRESHOLD = 2;
const LS_KEY = "stock_vehicle_v3";
const SETTINGS_KEY = "stock_vehicle_settings_v2";
const IMG_DIR = "./img/";

/* >>> DEFAULTS EN DUR (tu ne touches plus à rien) <<< */
const DEFAULT_GH = {
  owner: "bullyto",
  repo: "stock",
  branch: "main",
  stockPath: "stock",
  ext: ".json"
};

const PRODUCTS = [
  { id:"tequila_sanjose", name:"Tequila San José", barcode:"" },
  { id:"gibsons_gin", name:"Gibson’s Gin", barcode:"" },
  { id:"jagermeister", name:"Jägermeister", barcode:"" },
  { id:"perrier", name:"Perrier", barcode:"" },
  { id:"pastis_51", name:"Pastis 51", barcode:"3047100000247" },
  { id:"ricard", name:"Ricard", barcode:"" },
  { id:"havana_3ans", name:"Havana Club 3 ans", barcode:"" },
  { id:"get_27", name:"GET 27", barcode:"7610113009214" },
  { id:"gordons_gin", name:"Gordon’s Gin", barcode:"5000289925440" },
  { id:"liqueur_cassis", name:"Liqueur de cassis", barcode:"" },
  { id:"jack_old7", name:"Jack Daniel’s Old No.7", barcode:"3099873045864" },
  { id:"jack_honey", name:"Jack Daniel’s Tennessee Honey", barcode:"5099873001370" },
  { id:"old_nick_darkwood", name:"Old Nick Dark Wood", barcode:"" },
  { id:"captain_morgan", name:"Captain Morgan Spiced Gold", barcode:"5000281015249" },
  { id:"saint_james_blanc", name:"Saint James Rhum Blanc", barcode:"" },
  { id:"trois_rivieres", name:"Trois Rivières Rhum Blanc", barcode:"" },
  { id:"havana_especial", name:"Havana Club Especial", barcode:"" },
  { id:"old_nick_blanc", name:"Old Nick Rhum Blanc", barcode:"" },
  { id:"clan_campbell", name:"Clan Campbell", barcode:"" },
  { id:"ballantines", name:"Ballantine’s Finest", barcode:"" },
  { id:"poliakov", name:"Poliakov Vodka", barcode:"3147690130223" },
  { id:"absolut", name:"Absolut Vodka", barcode:"7312040017067" },
  { id:"ciroc_pomme", name:"Cîroc Pomme", barcode:"" },
  { id:"ciroc_classic", name:"Cîroc Classic", barcode:"" },
  { id:"ciroc_redberry", name:"Cîroc Red Berry", barcode:"" },
  { id:"william_peel", name:"William Peel", barcode:"5010327000148" },
  { id:"label_5", name:"Label 5 Classic Black", barcode:"3147690128573" },
  { id:"vin_rouge", name:"Vin rouge", barcode:"" },
  { id:"vin_blanc", name:"Vin blanc", barcode:"" },
  { id:"vin_rose", name:"Vin rosé", barcode:"" },
  { id:"muscat", name:"Muscat", barcode:"" }
];

const SEED_STOCK = {
  // 31 produits, 52 unités total, 15 faible/rupture
  perrier:3, pastis_51:3, ricard:3, get_27:3, captain_morgan:3, clan_campbell:3, ballantines:3, poliakov:3, absolut:3,
  william_peel:3, label_5:3, jack_old7:3, jack_honey:3, vin_rouge:3, vin_blanc:3, vin_rose:3,

  tequila_sanjose:1, gibsons_gin:1, jagermeister:1, muscat:1,

  havana_3ans:0, gordons_gin:0, liqueur_cassis:0, old_nick_darkwood:0, old_nick_blanc:0, saint_james_blanc:0,
  trois_rivieres:0, havana_especial:0, ciroc_pomme:0, ciroc_classic:0, ciroc_redberry:0
};

const state = {
  filter: "all",
  q: "",
  selectedId: null,
  stock: {},
  dirty: {},     // {id:true} => modifié localement non poussé
  token: "",     // le seul “paramètre”
  lastScan: { ean:"", matchId:null }
};

function seededStock(){
  const s = {};
  for(const p of PRODUCTS) s[p.id] = Number(SEED_STOCK[p.id] ?? 0);
  return s;
}

function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) throw new Error("no");
    const data = JSON.parse(raw);
    if(!data || typeof data.stock !== "object") throw new Error("bad");
    state.stock = data.stock || {};
    state.dirty = data.dirty || {};
  }catch{
    state.stock = seededStock();
    state.dirty = {};
    save();
  }

  try{
    const rawS = localStorage.getItem(SETTINGS_KEY);
    const s = rawS ? JSON.parse(rawS) : null;
    state.token = (s && s.token) ? String(s.token) : "";
  }catch{
    state.token = "";
  }
}
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify({ v: 3, savedAt: Date.now(), stock: state.stock, dirty: state.dirty }));
}
function saveToken(token){
  localStorage.setItem(SETTINGS_KEY, JSON.stringify({ v: 2, token: String(token||"") }));
  state.token = String(token||"");
}

/* ========= UI ========= */
const grid = document.getElementById("grid");
const q = document.getElementById("q");
const fAll = document.getElementById("fAll");
const fLow = document.getElementById("fLow");
const fZero = document.getElementById("fZero");
const miniStats = document.getElementById("miniStats");

const backdrop = document.getElementById("backdrop");
const sheet = document.getElementById("sheet");
const sheetName = document.getElementById("sheetName");
const sheetQty = document.getElementById("sheetQty");
const btnMinus = document.getElementById("btnMinus");
const btnPlus = document.getElementById("btnPlus");

const toast = document.getElementById("toast");
function toastMsg(text){
  toast.textContent = text;
  toast.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>toast.classList.remove("show"), 1500);
}

function normalizeName(s){ return (s||"").toLowerCase().trim(); }
function qtyClass(qty){
  if(qty <= 0) return "badgeZero";
  if(qty <= LOW_THRESHOLD) return "badgeLow";
  return "";
}
function bottleMonogram(name){
  const parts = name.replace("’","'").split(" ").filter(Boolean);
  const a = parts[0]?.[0] || "A";
  const b = parts[1]?.[0] || parts[0]?.[1] || "N";
  return (a + b).toUpperCase();
}

function computeStats(){
  const total = PRODUCTS.length;
  let units = 0;
  let lowOrZero = 0;
  let dirtyCount = 0;

  for(const p of PRODUCTS){
    const v = Number(state.stock[p.id] ?? 0);
    units += v;
    if(v === 0 || v <= LOW_THRESHOLD) lowOrZero++;
    if(state.dirty[p.id]) dirtyCount++;
  }

  miniStats.textContent = `${total} produits • ${units} unités • ${lowOrZero} faible/rupture` + (dirtyCount ? ` • ${dirtyCount} à enregistrer` : "");
}

function filteredProducts(){
  const qq = normalizeName(state.q);
  return PRODUCTS.filter(p => {
    const v = Number(state.stock[p.id] ?? 0);
    if(state.filter === "low" && !(v > 0 && v <= LOW_THRESHOLD)) return false;
    if(state.filter === "zero" && v !== 0) return false;
    if(qq && !normalizeName(p.name).includes(qq)) return false;
    return true;
  });
}

function render(){
  computeStats();
  const list = filteredProducts();

  grid.innerHTML = list.map(p => {
    const qty = Number(state.stock[p.id] ?? 0);
    const cls = qtyClass(qty);
    const tag = qty === 0 ? "Rupture" : (qty <= LOW_THRESHOLD ? "Faible" : "OK");
    const imgSrc = IMG_DIR + p.id + ".png";
    const mono = bottleMonogram(p.name);

    return `
      <div class="card" data-id="${p.id}" role="button" aria-label="${p.name}">
        <div class="cardTop">
          <div class="badgeQty ${cls}">x${qty}</div>
          <div class="bottle">
            <img src="${imgSrc}" alt="${p.name}" loading="lazy"
              onload="this.parentElement.classList.add('hasimg')"
              onerror="this.remove();"
            />
            <div class="fallback"><span>${mono}</span></div>
          </div>
        </div>
        <div class="cardBody">
          <div class="name">${p.name}</div>
          <div class="metaRow">
            <span>${tag}</span>
            <span class="tag">Tap = + / –</span>
          </div>
        </div>
      </div>`;
  }).join("");

  grid.querySelectorAll(".card").forEach(el => {
    el.addEventListener("click", () => openSheet(el.dataset.id));
  });

  updateSaveButtonsState();
}

function openSheet(id){
  state.selectedId = id;
  const p = PRODUCTS.find(x=>x.id===id);
  if(!p) return;

  const qty = Number(state.stock[id] ?? 0);
  sheetName.textContent = p.name;
  sheetQty.textContent = qty;

  backdrop.classList.add("show");
  sheet.classList.add("show");
}
function closeSheet(){
  backdrop.classList.remove("show");
  sheet.classList.remove("show");
  state.selectedId = null;
}
function adjust(delta){
  if(!state.selectedId) return;
  const id = state.selectedId;
  const v = Number(state.stock[id] ?? 0);
  const nv = Math.max(0, v + delta);
  state.stock[id] = nv;
  state.dirty[id] = true;
  sheetQty.textContent = nv;
  save();
  render();
  toastMsg(delta>0 ? "+1 ajouté" : "-1 retiré");
}

function setFilter(f){
  state.filter = f;
  fAll.classList.toggle("active", f==="all");
  fLow.classList.toggle("active", f==="low");
  fZero.classList.toggle("active", f==="zero");
  render();
}

/* ========= GitHub dépôt : 1 fichier par bouteille ========= */
const btnSaveRepo = document.getElementById("btnSaveRepo");
const btnSettings = document.getElementById("btnSettings");

function getGH(){
  return {
    owner: DEFAULT_GH.owner,
    repo: DEFAULT_GH.repo,
    branch: DEFAULT_GH.branch,
    stockPath: DEFAULT_GH.stockPath,
    ext: DEFAULT_GH.ext,
    token: String(state.token||"").trim()
  };
}

function updateSaveButtonsState(){
  const s = getGH();
  const hasToken = !!s.token;
  const dirtyCount = Object.keys(state.dirty).length;
  btnSaveRepo.disabled = !(hasToken && dirtyCount);
}

function b64encodeUnicode(str){
  return btoa(unescape(encodeURIComponent(str)));
}

async function ghApi(path, options={}){
  const s = getGH();
  const headers = options.headers || {};
  headers["Accept"] = "application/vnd.github+json";
  if(s.token) headers["Authorization"] = "token " + s.token;
  if(options.json) headers["Content-Type"] = "application/json";
  const res = await fetch("https://api.github.com" + path, { ...options, headers });
  return res;
}

async function ghGetSha(owner, repo, filePath, branch){
  const res = await ghApi(`/repos/${owner}/${repo}/contents/${encodeURIComponent(filePath).replace(/%2F/g,"/")}?ref=${encodeURIComponent(branch)}`);
  if(res.status === 404) return null;
  if(!res.ok) throw new Error("GET sha failed");
  const data = await res.json();
  return data.sha || null;
}

async function ghPutFile(owner, repo, filePath, branch, message, contentStr){
  const sha = await ghGetSha(owner, repo, filePath, branch);
  const body = { message, content: b64encodeUnicode(contentStr), branch };
  if(sha) body.sha = sha;

  const res = await ghApi(`/repos/${owner}/${repo}/contents/${encodeURIComponent(filePath).replace(/%2F/g,"/")}`, {
    method:"PUT",
    json:true,
    body: JSON.stringify(body)
  });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    throw new Error("PUT failed: " + res.status + " " + t.slice(0,160));
  }
  return true;
}

function fileForId(id){
  const s = getGH();
  const ext = s.ext.startsWith(".") ? s.ext : ("." + s.ext);
  return `${s.stockPath}/${id}${ext}`;
}
function snapshotPath(){
  const s = getGH();
  return `${s.stockPath}/_snapshot.json`;
}

async function pushToRepo(){
  const s = getGH();
  if(!s.token){
    toastMsg("Ajoute ton token pour écrire");
    openSettings();
    return;
  }
  const dirtyIds = Object.keys(state.dirty);
  if(!dirtyIds.length){
    toastMsg("Rien à enregistrer");
    return;
  }

  btnSaveRepo.disabled = true;
  toastMsg("Enregistrement…");

  const now = new Date().toISOString();
  const msgBase = `stock: update ${now}`;

  for(const id of dirtyIds){
    const qty = Number(state.stock[id] ?? 0);
    const payload = { id, qty, updatedAt: now };
    await ghPutFile(s.owner, s.repo, fileForId(id), s.branch, msgBase + ` (${id})`, JSON.stringify(payload, null, 2));
  }

  const snapshot = {
    v: 1,
    updatedAt: now,
    items: PRODUCTS.map(p => ({ id: p.id, qty: Number(state.stock[p.id] ?? 0) }))
  };
  await ghPutFile(s.owner, s.repo, snapshotPath(), s.branch, msgBase + " (_snapshot)", JSON.stringify(snapshot, null, 2));

  state.dirty = {};
  save();
  render();
  toastMsg("Dépôt mis à jour ✅");
}

async function pullFromRepo(){
  const s = getGH();
  toastMsg("Chargement dépôt…");

  const snapFile = snapshotPath();
  let snap = null;

  try{
    if(s.token){
      const res = await ghApi(`/repos/${s.owner}/${s.repo}/contents/${encodeURIComponent(snapFile).replace(/%2F/g,"/")}?ref=${encodeURIComponent(s.branch)}`);
      if(res.ok){
        const data = await res.json();
        const content = data.content ? atob(data.content.replace(/\n/g,"")) : "";
        snap = JSON.parse(content);
      }
    }else{
      const rawUrl = `https://raw.githubusercontent.com/${s.owner}/${s.repo}/${s.branch}/${snapFile}?t=${Date.now()}`;
      const res = await fetch(rawUrl, { cache:"no-store" });
      if(res.ok) snap = await res.json();
    }
  }catch{}

  if(snap && Array.isArray(snap.items)){
    for(const it of snap.items){
      if(!it || !it.id) continue;
      const v = Number(it.qty);
      if(Number.isFinite(v) && v >= 0) state.stock[it.id] = Math.floor(v);
    }
    state.dirty = {};
    save();
    render();
    toastMsg("Stock chargé ✅");
    return;
  }

  toastMsg("Snapshot absent : charge impossible");
}

/* ========= Settings modal (token only) ========= */
const settingsEl = document.getElementById("settings");
const btnCloseSettings = document.getElementById("btnCloseSettings");
const btnSaveToken = document.getElementById("btnSaveToken");
const btnPullRepo = document.getElementById("btnPullRepo");
const ghToken = document.getElementById("ghToken");

function openSettings(){
  ghToken.value = String(state.token||"");
  settingsEl.classList.add("show");
  settingsEl.setAttribute("aria-hidden","false");
}
function closeSettings(){
  settingsEl.classList.remove("show");
  settingsEl.setAttribute("aria-hidden","true");
}

btnSettings.addEventListener("click", openSettings);
btnCloseSettings.addEventListener("click", closeSettings);
settingsEl.addEventListener("click", (e)=>{ if(e.target === settingsEl) closeSettings(); });

btnSaveToken.addEventListener("click", ()=>{
  const t = (ghToken.value||"").trim();
  saveToken(t);
  render();
  toastMsg(t ? "Token enregistré ✅" : "Token supprimé ✅");
  closeSettings();
});

btnPullRepo.addEventListener("click", async ()=>{
  await pullFromRepo();
});

btnSaveRepo.addEventListener("click", pushToRepo);

/* ========= Bind UI ========= */
backdrop.addEventListener("click", closeSheet);
btnMinus.addEventListener("click", ()=>adjust(-1));
btnPlus.addEventListener("click", ()=>adjust(+1));
fAll.addEventListener("click", ()=>setFilter("all"));
fLow.addEventListener("click", ()=>setFilter("low"));
fZero.addEventListener("click", ()=>setFilter("zero"));
q.addEventListener("input", ()=>{ state.q = q.value || ""; render(); });

/* ========= Scanner EAN (BarcodeDetector) ========= */
const fabScan = document.getElementById("fabScan");
const scanModal = document.getElementById("scanModal");
const btnCloseScan = document.getElementById("btnCloseScan");
const btnTorch = document.getElementById("btnTorch");
const btnCancelDeduct = document.getElementById("btnCancelDeduct");
const btnConfirmDeduct = document.getElementById("btnConfirmDeduct");
const eanText = document.getElementById("eanText");
const matchText = document.getElementById("matchText");
const scanBadge = document.getElementById("scanBadge");
const video = document.getElementById("video");

let stream = null;
let detector = null;
let scanTimer = null;
let torchOn = false;
let trackForTorch = null;

function findProductByEAN(ean){
  ean = String(ean||"").trim();
  if(!ean) return null;
  return PRODUCTS.find(p => p.barcode && String(p.barcode).trim() === ean) || null;
}

async function openScanner(){
  scanModal.classList.add("show");
  scanModal.setAttribute("aria-hidden","false");
  eanText.textContent = "—";
  matchText.textContent = "Présente la bouteille dans le cadre";
  scanBadge.textContent = "x0";
  state.lastScan = { ean:"", matchId:null };
  btnConfirmDeduct.disabled = true;

  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
    video.srcObject = stream;
    await video.play();

    trackForTorch = stream.getVideoTracks()[0] || null;

    if ("BarcodeDetector" in window) {
      detector = new BarcodeDetector({ formats: ["ean_13","ean_8","upc_a","upc_e","code_128","code_39","qr_code"] });
      startScanLoop();
      toastMsg("Scanner prêt ✅");
    } else {
      matchText.textContent = "BarcodeDetector non supporté (Chrome Android conseillé)";
      toastMsg("Scanner non supporté ❌");
    }
  }catch{
    matchText.textContent = "Accès caméra refusé ou indisponible";
    toastMsg("Caméra impossible ❌");
  }
}

function closeScanner(){
  scanModal.classList.remove("show");
  scanModal.setAttribute("aria-hidden","true");
  stopScanLoop();
  stopCamera();
}
function stopCamera(){
  try{ if(stream){ stream.getTracks().forEach(t=>t.stop()); } }catch{}
  stream = null;
  detector = null;
  trackForTorch = null;
  torchOn = false;
}
function startScanLoop(){
  stopScanLoop();
  scanTimer = setInterval(scanOnce, 250);
}
function stopScanLoop(){
  if(scanTimer) clearInterval(scanTimer);
  scanTimer = null;
}
async function scanOnce(){
  if(!detector) return;
  if(video.readyState < 2) return;

  try{
    const barcodes = await detector.detect(video);
    if(!barcodes || !barcodes.length) return;

    const raw = barcodes[0].rawValue || "";
    if(!raw) return;
    if(state.lastScan.ean === raw) return;

    state.lastScan.ean = raw;
    eanText.textContent = raw;

    const prod = findProductByEAN(raw);
    if(prod){
      state.lastScan.matchId = prod.id;
      const qty = Number(state.stock[prod.id] ?? 0);
      matchText.textContent = `Trouvé : ${prod.name}`;
      scanBadge.textContent = `x${qty}`;
      btnConfirmDeduct.disabled = false;
    }else{
      state.lastScan.matchId = null;
      matchText.textContent = "EAN inconnu (ajoute le code-barres plus tard)";
      scanBadge.textContent = "x?";
      btnConfirmDeduct.disabled = true;
    }
  }catch{}
}
async function toggleTorch(){
  if(!trackForTorch) return toastMsg("Flash non dispo");
  const caps = trackForTorch.getCapabilities ? trackForTorch.getCapabilities() : {};
  if(!caps.torch){ toastMsg("Flash non dispo"); return; }
  torchOn = !torchOn;
  try{
    await trackForTorch.applyConstraints({ advanced: [{ torch: torchOn }] });
    toastMsg(torchOn ? "Flash ON" : "Flash OFF");
  }catch{
    toastMsg("Flash impossible");
  }
}
function deductOneFromMatched(){
  const id = state.lastScan.matchId;
  if(!id) return;
  const v = Number(state.stock[id] ?? 0);
  if(v <= 0){ toastMsg("Déjà à 0"); return; }
  state.stock[id] = v - 1;
  state.dirty[id] = true;
  save();
  render();
  const p = PRODUCTS.find(x=>x.id===id);
  toastMsg(`-1 ${p ? p.name : ""}`);
  scanBadge.textContent = `x${state.stock[id]}`;
}

fabScan.addEventListener("click", openScanner);
btnCloseScan.addEventListener("click", closeScanner);
scanModal.addEventListener("click", (e)=>{ if(e.target === scanModal) closeScanner(); });
btnTorch.addEventListener("click", toggleTorch);
btnCancelDeduct.addEventListener("click", ()=>{
  state.lastScan = { ean:"", matchId:null };
  eanText.textContent = "—";
  matchText.textContent = "Présente la bouteille dans le cadre";
  scanBadge.textContent = "x0";
  btnConfirmDeduct.disabled = true;
});
btnConfirmDeduct.addEventListener("click", ()=>{
  if(!state.lastScan.matchId) return;
  if(!confirm("Confirmer la déduction de 1 unité ?")) return;
  deductOneFromMatched();
});

/* ========= Boot ========= */
load();
render();

// Auto-charger depuis dépôt au démarrage (si online et pas de modifs locales)
(async ()=>{
  if(navigator.onLine && !Object.keys(state.dirty||{}).length){
    await pullFromRepo().catch(()=>{});
  }
})();
</script>
</body>
</html>
